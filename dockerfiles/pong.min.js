$(document).ready(function(){$(window).on("beforeunload",function(){$(window).scrollTop(0)});$("#loading").fadeIn();var ai=window.innerWidth,ak=window.innerHeight,o=ai*0.9,a=160;var H,h,ac,I,am,d,af,z,c,m,C,V="black",Z=a*0.8,O=20,S=45,L=10,B=5,w=false,p=false,ah=false;var F=d3.stack();var R=d3.area().x(function(ap,ao){return s(ap.data.index)}).y0(function(ao){return ad(ao[0])}).y1(function(ao){return ad(ao[1])}).curve(d3.curveStepAfter);var aa=["#E04B4B","#6094C3","#63BC6A","#A76BB2","#F0934E","#FEFB54","#B37855","#EF91CA","#A4A4A4"];var J=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"];var l=0;var ac;var s=d3.scale.linear(),ad=d3.scale.linear();var ag=d3.behavior.zoom().on("zoom",al);var E;var X=new Array();var r=$(window).width();$(window).resize(function(){if($(this).width()!=r){r=$(this).width();if(this.resizeTO){clearTimeout(this.resizeTO)}this.resizeTO=setTimeout(function(){$("#resize-warning-nav").show()},500)}});$("#resize-warning-exit").click(function(){$("#resize-warning-nav").hide()});var g=(location.protocol=="https:"?"wss://":"ws://")+location.host+location.pathname+"pongsocket";var b=new WebSocket(g);var D=0;var U=0;b.onmessage=function(au){var at=JSON.parse(au.data);if(at.type=="pong-data"){ac=at.pong;for(var aq in ac.qmatrices){modes=Object.keys(ac.qmatrices[aq].modes).length;if(modes==1){U+=1}else{U+=modes+1}}$("#loading").fadeIn();l+=ac.qmatrices.length;if(ac.hasOwnProperty("popNames")&&ac.hasOwnProperty("popSizes")){I=ac.popNames;am=ac.popSizes}else{I={};am={}}if(ac.colors.length>0){aa=ac.colors}else{if(ac.K_max>9){aa=J}}H=new Array();for(aq=0;aq<ac.qmatrices.length;aq++){var ar=ac.qmatrices[aq].major_mode_runid;plot=d3.select("#visualization").append("svg").attr("width",o).attr("height",a+15).attr("class","majorSVG "+ac.qmatrices[aq].K).attr("id","plot"+ar);H.push(plot);q(ar,"no",null,null)}}else{if(at.type=="q-matrix"){D+=1;d3.select("#progress-bar").transition().attr("width",280*D/U);var ao;if(at.minor=="yes"){ao=true}else{ao=false}var av=at.minorID;var ap=at.is_first;if(!ao){u(d3.select("#plot"+at.name),at.K,at.matrix2d,ao,av,ap,at.name)}else{u(d3.select("#plot"+at.name+"_minor"),at.K,at.matrix2d,ao,av,ap,at.name)}}}};var q=function(aq,ao,ar,ap){b.send(JSON.stringify({type:"get-qmatrix",name:aq,minor:ao,minorID:ar,is_first:ap}))};var u=function(aA,au,aK,aD,aq,aJ,aO){var ao=Z;var aI=ac.qmatrices[au-ac.K_min].color_perm;d=o*0.84;c=o*0.08;m=0;var ar=ac.qmatrices[au-ac.K_min];var aG=ar.major_mode_runid;var ap=Object.keys(ar.modes);var aE=ap.indexOf(aG);if(aE>-1){ap.splice(aE,1)}var av=A(ar,ap);if(ap.length!=0&&!aD){l+=ap.length+1;K(au,av)}if(!aD){an(aA,au,ar);f(aA,au,aG)}else{M(aA,ar,aq,aJ)}var aM=15;var aF=5;aA.append("rect").attr("class","background").attr("x",c-aF/2).attr("y",aM-aF/2).attr("height",ao+aF).attr("width",d+aF).attr("fill",V);var az=aA.append("g").attr("transform","translate("+c+", "+aM+")").attr("class","chart").attr("clip-path","url(#clip)");az.append("clipPath").attr("id","clip").append("rect").attr("width",d).attr("height",ao+50);C=1+aK.slice(-1)[0].members.slice(-1)[0].index;s.range([0,d]).domain([0,C]);ad.range([ao,0]).domain([0,1]);tickVals=[];aK.forEach(function(aP){tickVals.push(aP.members[0].index)});var aw=Object.keys(aK[0].members[0]).filter(function(aP){return aP!="index"}).sort(y);F.keys(aw);var aH=az.selectAll(".pops").data(aK).enter().append("g").attr("class",function(aP){return"pops population"+aP.population_index});var aL=aH.selectAll(".layer").data(function(aR){var aQ=F(aR.members);for(var aP=0;aP<aQ.length;aP++){aQ[aP].population_index=aR.population_index;aQ[aP].K=au;aQ[aP].indiv_avg=ac.indiv_avg[aO][aR.population_index]}return aQ}).enter().append("g").attr("class","layer");aL.append("path").attr("class",function(aR,aP){var aQ="area ";if(aD){aQ+=aq+"_minorCluster"+aI[aP]+" "}aQ+="K"+aR.K+" population"+aR.population_index+" cluster"+aI[aP];return aQ}).style("fill",function(aQ,aP){return aa[aI[aP]]}).attr("d",function(aQ,aP){var aR=[0,0];aR.data={index:aQ[aQ.length-1].data.index+1};aQ[aQ.length]=aR;return(R(aQ))}).on("click",function(aP){if(!ah){d3.selectAll("path.area").style("fill",function(aR){var aQ=ac.qmatrices[aR.K-ac.K_min].color_perm;if(!w){if(aQ[parseInt(aR.key.slice(7))-1]!=aI[parseInt(aP.key.slice(7))-1]){return"white"}else{return aa[aQ[parseInt(aR.key.slice(7))-1]]}}else{return aa[aQ[parseInt(aR.key.slice(7))-1]]}});if(!w){d3.selectAll(".check-input").attr("disabled","disabled")}else{d3.selectAll(".check-input").attr("disabled",null)}w=!w}});var aC=d3.selectAll("path.area");aC.call(ag).on("dblclick.zoom",null);if(Object.keys(I).length>0){aC.call(j).on("mouseover",j.show).on("mouseout",j.hide)}var at=d3.selectAll("#major_repstring");at.call(k).on("mouseover",k.show).on("mouseout",k.hide);if(aD){var aN=d3.selectAll("#minor_repstring");aN.call(k).on("mouseover",k.show).on("mouseout",k.hide)}E=d3.svg.axis().scale(s).orient("bottom").tickValues(tickVals).tickFormat("").tickSize(-ao);az.append("g").attr("class","x axis").attr("transform","translate(0,"+ao+")").style("fill","none").style("stroke",V).call(E);ag.x(s).scaleExtent([1,20]);d3.select("#whiteout"+au).on("click",function(){for(i in av){n(au,av[i],aI,z)}ah=!ah});if(au==ac.K_max&&!aD){var ay=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",o+80);var aB=ay.append("g").attr("class","labelSVG").attr("transform","translate("+(c-aF/2)+",0)");if(Object.keys(I).length>0){G(aB,false,au,tickVals)}ay.attr("height",aB.node().getBBox().height+80)}else{if(aq&&aq==av.slice(-1)[0]){var ay=d3.select("#modal_body_"+au).append("svg").attr("class","minorPopLabels_"+au).attr("height",a).attr("width",o);var aB=ay.append("g").attr("class","labelSVGminor_"+au).attr("transform","translate("+(c-aF/2)+",0)");if(Object.keys(I).length>0){G(aB,true,au,tickVals)}P(au)}}aj(aA,au,ar,aD,ac.K_min,"print");if(!aD){var ax=ar.major_mode_runid}if(aD){var ax=aA[0][0].getAttribute("id").slice(4)}$("#"+ax+"_print").click(function(aP){aP.preventDefault();e(ar,aD,aA,ax,"print")});$("#"+ax+"_download_png").click(function(aP){aP.preventDefault();e(ar,aD,aA,ax,"png")});$("#"+ax+"_download_svg").click(function(aP){aP.preventDefault();e(ar,aD,aA,ax,"svg")});$(document).ready(function(){$('[data-toggle="tooltip"]').tooltip()});l--;if(l===0){$("#loading").delay(200).fadeOut()}};function al(){if(s.domain()[0]<0){var ao=ag.translate()[0]-s(0)+s.range()[0];ag.translate([ao,0])}else{if(s.domain()[1]>C){var ao=ag.translate()[0]-s(C)+s.range()[1];ag.translate([ao,0])}}d3.selectAll("g.x.axis").call(E);var ap=d3.event.translate[0],aq=d3.event.scale;ap=Math.min(0,Math.max(d*(1-aq),ap));d3.selectAll("path.area").attr("transform","translate("+ap+",0)scale("+aq+", 1)");d3.selectAll(".popLabels").attr("transform",function(av){var at=s(av)+B,ar=L,au=S;return"translate("+at+","+ar+")rotate("+au+")"}).style("fill",function(ar){if(s(ar)+B<0||s(ar)+B>d){return"none"}else{return"black"}})}var G=function(aq,ap,ao,ar){var at=aq.selectAll(".popLabels").data(ar).enter().append("text").style("font-family","Helvetica").text(function(av,au){return I[au]}).attr("transform",function(ax){var av=s(ax)+B,au=L,aw=S;return"translate("+av+","+au+")rotate("+aw+")"}).attr("class","popLabels noSelect").attr("id",function(av,au){return"major_pop"+au}).on("click",function(av,au){if(d3.event.shiftKey&&p){var aw=d3.selectAll("path.area.population"+au);if(aw.attr("fill-opacity")==1){aw.attr("fill-opacity",0.2)}else{aw.attr("fill-opacity",1)}}else{d3.selectAll("path.area").attr("fill-opacity",function(ay){var ax=ac.qmatrices[ay.K-ac.K_min].color_perm;if(!p){if(ay.population_index!=au){return 0.2}else{return 1}}else{return 1}});p=!p}})};var N=function(ap,ao){labelsvg=d3.select("."+ao).select("g").node();return[labelsvg.getBBox().height+15,labelsvg.getBBox().width+labelsvg.getBBox().x+15]};var K=function(ao,ap){var ar=d3.select("body").append("div").attr("class","buttonDiv");var aq=ar.append("button").attr("class","modes btn btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+ao).attr("id","button-"+ao);aq.style("position","absolute").style("top",129+(a+20)*(ao-ac.K_min)+98+"px").style("left",(c+o*0.84+20)+"px");aq.html('<i class="fa fa-plus"></i> <span style="font-weight:bold; font-size:125%;">'+ap.length+"</span>");v(ao,ap,aq,ar)};var v=function(az,av,aw,aC){var ay=aC.append("div").attr("class","modal fade").attr("id","modal-"+az).attr("role","dialog");var at=ay.append("div").attr("class","modal-dialog");var au=at.append("div").attr("class","modal-content").attr("id","modal-content-"+az).style("width",(o+45)+"px").style("left",(m+10)+"px");var ap=au.append("div").attr("class","modal-header").attr("id","title"+az);var aF=ap.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").html("<span>&times;</span>");var aB=ap.append("h2").attr("class","modal-title").html("Clustering modes, K="+az);h=new Array();var aq=ac.qmatrices[az-ac.K_min].color_perm;$("#modal-"+az).on("hide.bs.modal",function(aG){if(ah){for(i in av){n(az,av[i],aq,z)}ah=false;$("#whiteout"+az).attr("checked",false)}});var aA=au.append("div").attr("class","modal-header").attr("id","modal_header2_"+az);dirtyGray=0;for(i=0;i<av.length;i++){var ar=av[i];minor_obj=ac.qmatrices[az-ac.K_min].modes[ar];if(minor_obj.gray_indices.length!=0){dirtyGray=1;break}}if(dirtyGray){var ax=aA.append("label").attr("class","checkbox-inline");ax.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+az);ax.style("position","relative").style("top","4px");var aE=aA.append("label").attr("class","checkbox-caption noSelect").attr("for","whiteout"+az).text("\nCheck to highlight multimodality: ")}else{if(av.length==1){mymodestr="minor mode"}else{mymodestr="minor modes"}aA.append("button").attr("type","submit").attr("class","btn btn-danger btn-small pull-right").attr("id","highlightMM_"+az).attr("data-toggle","tooltip").attr("data-placement","left").attr("title","Similarity between corresponding clusters in the major mode and "+mymodestr+" is less than the similarity threshold of "+ac.sim_threshold+". Lower the similarity threshold in pong's command line to enable highlighting.").text("Why can't I highlight multimodality?")}var ao=ac.qmatrices[az-ac.K_min].major_mode_runid;plot=d3.select("#modal_header2_"+az).append("svg").attr("width",o).attr("height",a+15).attr("class","minorSVG-"+az+" first").attr("id","plot"+ao+"_minor");h.push(plot);q(ao,"yes",ao,"yes");var aD=au.append("div").attr("class","modal-body").attr("id","modal_body_"+az);for(i=0;i<av.length;i++){var ar=av[i];plot=d3.select("#modal_body_"+az).append("svg").attr("width",o).attr("height",a+15).attr("class","minorSVG-"+az).attr("id","plot"+ar+"_minor");h.push(plot);q(ar,"yes",ar,"no")}};var an=function(at,aw,ar){var au=ar.total_runs;var ap=ar.major_mode_runid;var av=ar.modes[ap].runs_represented.length;var aq=0.5*Z+0.5*O;label=at.append("text").text("K = "+aw);label.attr("class","label").style("font","bold 20px Helvetica, sans-serif");label.attr("x",0).attr("y",aq);runs=at.append("text").text(av+"/"+au+" runs").attr("id","major_repstring");runs.attr("x",0).attr("y",aq+25);runs.style("font","12px Helvetica, sans-serif");var ay=new Array(ar.modes[ap].runs_represented.sort().join("-"),"runs");runs.data(ay);runs.style("fill","#5bc0de").style("text-decoration","underline");var ax=document.getElementById("major_repstring").getBBox();var ao=ax.width;if(ao>c){c=ao+5}avg_sim=ar.modes[ap].avg_sim;if(avg_sim!=null){sim=at.append("text").text("Avg. pairwise similarity: "+avg_sim.toString().substring(0,5));sim.attr("x",c).attr("y",9);sim.style("fill","rgb(70, 184, 218)");sim.style("font","bold 11px Helvetica, sans-serif")}};var M=function(ao,au,aw,ap){var av=au.total_runs;var aq=au.modes[aw].runs_represented.length;var at=0.5*Z*0.85+0.5*O;if(ap=="yes"){major=ao.append("text").text("major mode");major.attr("class","majorMinorLabel").attr("id","minor_bigstring");major.attr("x",0).attr("y",at-38-15);major.style("font","bold 14px Helvetica, sans-serif")}if(83.609>c){c=83.609+5}label=ao.append("text").text(aw);label.attr("class","label");label.attr("x",0).attr("y",at-26);label.style("font","20px Helvetica, sans-serif");rep=ao.append("text").text("represents");rep.attr("x",0).attr("y",at+14-26);rep.style("font","12px Helvetica, sans-serif");runs=ao.append("text").text(aq+"/"+av+" runs");runs.attr("id","minor_repstring");runs.attr("x",0).attr("y",at+30-26);runs.style("font","12px Helvetica, sans-serif");var ar=new Array(au.modes[aw].runs_represented.sort().join("-"),"runs");runs.data(ar);runs.style("fill","#5bc0de").style("text-decoration","underline");avg_sim=au.modes[aw].avg_sim;if(avg_sim!=null){sim=ao.append("text").text("Avg pairwise similarity:"+avg_sim.toString().substring(0,5));sim.attr("class","avg_sim");sim.attr("x",c).attr("y",10);sim.style("fill","rgb(70, 184, 218)");sim.style("font","bold 12px Helvetica, sans-serif")}return(0)};var A=function(au,aw){var av={};for(var ar in aw){var aq=aw[ar];var at=au.modes[aq].runs_represented.length;av[aq]=at}var ap=Object.keys(av).map(function(ax){return[ax,av[ax]]});ap.sort(function(ay,ax){return ax[1]-ay[1]});var ao=new Array();for(var ar in ap){ao.push(ap[ar][0])}return ao};var n=function(au,ap,ao,at){var aw=ac.qmatrices[au-ac.K_min].modes[ap];if(aw.gray_indices!=null){var aq=aw.gray_indices;for(i in aw.gray_indices){var ax=ao[aq[i]];var ay="."+ap+"_minorCluster"+ax;var av=d3.select("#modal_body_"+au).select(".printModal");var ar=d3.select("#modal_body_"+au).select(".modalDropdown a div");if(d3.selectAll(ay).style("fill")!="rgb(255, 255, 255)"){d3.selectAll(ay).style("fill","white");av.classed("btn btn-primary",true).text("Print highlighting multimodality at K="+au);ar.classed("btn btn-primary",true).text("Download highlighting multimodality at K="+au)}else{d3.selectAll(ay).style("fill",aa[ao[aq[i]]]);av.classed("btn-primary",false).text("Print all modes at K="+au);ar.classed("btn-primary",false).text("Download all modes at K="+au)}}}};var f=function(ap,ao){var ar=ac.qmatrices[ao-ac.K_min].avg_sim_bt_modes;var aq=Math.round(ar*1000)/1000;if(aq!=null){simMode=d3.select("#title"+ao).append("h4").text("\nAvg pairwise similarity among modes = "+aq)}};var k=d3.tip().direction("s").attr("class","d3-tip").offset([10,0]).attr("font-size","14px").html(function(at){var aq=at.split("-");var ap='<div class="text-center text-tip"><strong>runs<br>represented</strong>';for(var ar=0,ao=aq.length;ar<ao;ar++){ap+="<br>"+aq[ar]}return(ap)});var j=d3.tip().direction("s").attr("class","d3-tip").offset([10,0]).html(function(au){var ap=au.K;var at=ac.qmatrices[ap-ac.K_min].color_perm;var ao='<div class="text-center text-tip"><strong>'+I[au.population_index]+"</strong><br>"+am[au.population_index]+" samples</div><br>";ao+="<div><ul>";var ar=[];for(var aq=0;aq<ap;aq++){ar.push({datum:au.indiv_avg[aq],color:aa[at[aq]]})}ar.sort(function(aw,av){return((aw.datum>av.datum)?-1:((aw.datum==av.datum)?0:1))});ar.forEach(function(av,ay){var ax=Math.round(av.datum*1000)/10;var aw=av.color;if(ax>=0.5){ao+='<i class="fa fa-circle" style="color: '+aw+' "></i>';ao+="&nbsp;<strong> "+ax+"%</strong></li><br>"}});ao+="</ul></div>";return ao});var x=new Tour({storage:false});x.addSteps([{placement:"top",backdrop:true,orphan:true,title:"Welcome to pong!",content:"This tour will walk you through pong's main features."},{element:".background:first",placement:"bottom",title:"The major mode plot",content:function(){return"This plot shows a representative run of the major mode for K = "+ac.K_min+". You can zoom in and out of the plots by placing your cursor above the plot and performing a mouse scroll. Clicking on a color within  a plot will highlight that color across K values in all plots (including minor modes)."}},{element:"#major_repstring:first",placement:"right",title:"Runs represented",content:function(){return"Hovering here shows you which runs are represented by the major mode plot for K = "+ac.K_min+", sorted by runID."}},{element:".majorPopLabels",placement:"top",title:"Population labels",content:function(){return"Clicking on a population label will highlight that population across K values. Shift-clicking allows you to select multiple populations."}},{element:".pbDiv:last",placement:"right",title:"Print and download",content:"These icons let you print a plot or download it locally as a PNG or SVG."},{element:".print-download",placement:"top",title:"Print and download everything",content:"Alternatively, use these buttons to print/download all currently displayed plots in one file."},{element:"button.modes:last",placement:"left",title:"Minor modes",content:"If there is multimodality for a given K value, you can click on this button to see representative runs for the minor mode(s)."},{orphan:true,placement:"top",backdrop:true,title:"That's the bulk of it!",content:"Consult the documentation to find out more about pong's features. Feel free to reach out to us directly if you have any questions or feedback. We hope you enjoy using pong!"}]);x.init();$("#help").on("click",function(){x.restart()});$(document).on("click","#printAllPlots",function(){ae("no","print")});$(document).on("click",".printModal",function(){var ao=$(this)[0].id;ae(ao,"print")});$(document).on("click","#main_png",function(){ae("no","png")});$(document).on("click","#main_svg",function(){ae("no","svg")});$(document).on("click",".downloadModalPNG",function(){var ao=$(this)[0].id;ae(ao,"png")});$(document).on("click",".downloadModalSVG",function(){var ao=$(this)[0].id;ae(ao,"svg")});var P=function(ao){var at="reply_Modal(this)";var au=d3.select("#modal_body_"+ao).append("div").attr("class","modal-body").append("div").attr("class","row").append("div").attr("class","text-center");var ap=au.append("button").attr("type","submit").attr("class","btn btn-default printModal").attr("id",ao).text("Print all modes at K="+ao);var ar=au.append("div").attr("class","dropdown dropdown-toggle modalDropdown");var aq=ar.append("a").attr("class","dropdown").attr("data-toggle","dropdown").attr("aria-expanded","false").append("div").attr("class","btn btn-default").text("Download all modes at K="+ao);Y(ar,ao,aq,true)};var Y=function(ax,au,aw,at){var av=ax.append("ul").attr("class","dropdown-menu download-menu").attr("id",au+"_dropdown");var ap=av.append("div").attr("class","slider").style("margin","10px").style("margin-left","15px").style("margin-right","15px").style("font-size","12px").attr("id","slider_div_"+au);ap.append("div").attr("class","img_slider").text("Image size");ap.append("div").attr("id","slider_"+au);ap.on("click",function(){d3.event.stopPropagation();d3.event.preventDefault()});var ar=ap.append("div").attr("class","slider_axis").style("display","flex").style("justify-content","space-between").style("width","100%").style("font-size","9px");ar.append("div").text("Smaller");ar.append("div").text("Larger");var aq=av.append("li").append("a").attr("data-format","png").attr("title","Download plot as PNG").text("PNG");var ao=av.append("li").append("a").attr("data-format","svg").attr("title","Download plot as SVG").text("SVG");if(at){aq.attr("class","downloadModalPNG").attr("id",au);ao.attr("class","downloadModalSVG").attr("id",au)}else{aq.attr("id",au+"_png");ao.attr("id",au+"_svg")}if(!Modernizr.adownload){aw.attr("data-toggle","tooltip").attr("data-placement","top").attr("title","Download not fully supported in this browser. Please save the following page after selecting a file type to download locally.");ao.append("tspan").text(" (Save with format 'Page Source')").style("font-size","10px")}$("#slider_"+au).slider({value:2,min:1,max:3,step:0.5})};var aj=function(ax,aA,aw,ar,ao,ay){if(!ar){var aB=d3.select("body").append("div").attr("class","pbDiv").style("top",(a*1.125)*(aA-ao+1)+110+"px");var aD=aw.major_mode_runid+"_print";var at=aw.major_mode_runid+"_download"}if(ar){var aB=d3.select("#modal_body_"+aA).append("div").attr("class","pbDiv");var aD=ax[0][0].getAttribute("id").slice(4)+"_print";var at=ax[0][0].getAttribute("id").slice(4)+"_download";var ap=(ax[0][0].getAttribute("id").slice(4)).slice(0,ax[0][0].getAttribute("id").slice(4).indexOf("_minor"));var av=Object.keys(aw.modes);var au=A(aw,av);var aC=au.indexOf(ap);if(aC==0){aB.style("top",a*0.5*(-1)+"px")}else{aB.style("top",((a*1.125)*(aC-1))+130+"px")}}var aq="32px";aB.style("position","absolute").style("display","inline-flex").style("left",aq);var az=aB.append("a").attr("id",aD).style("margin","4px").append("span").attr("class","glyphicon glyphicon-print");if(!ar){az.attr("title","Print K="+aA+" barplot");az.attr("id","print-major-"+aA)}else{az.attr("title","Print "+ap+" barplot");az.attr("id","print-minor-"+ap)}aB=aB.append("div").attr("class","dropdown").style("margin","4px");var az=aB.append("a").attr("id",at).attr("data-toggle","dropdown").attr("class","dropdown-toggle").attr("aria-expanded","false").attr("aria-hadpopup","true").append("span").attr("class","glyphicon glyphicon-download-alt");Y(aB,at,az,false);if(!ar){az.attr("id","download-major-"+aA)}else{az.attr("id","download-minor-"+ap)}};var t=2;function W(ap,ao,ar){var aq=$("#slider_main");if(ao&&ap!="no"){aq=$("#slider_"+ap)}else{if(ap!="no"){aq=$("#slider_"+ap+"_download")}}if(ar=="png"&&ao){return aq.slider("option","value")*0.5}return aq.slider("option","value")}function T(ap,ao){var aq=document.createElement("a");aq.href=ap.src;aq.type="hidden";aq.download=ao;document.body.appendChild(aq);aq.click();document.body.removeChild(aq)}function Q(ap,ao){var aq=document.createElement("a");aq.href=ap.toDataURL("image/png");aq.type="hidden";aq.download=ao;document.body.appendChild(aq);aq.click();document.body.removeChild(aq)}function e(at,aC,aB,ao,ar){t=W(ao,false,ar);var aE=d3.select("#plot"+ao).node();var ax=d3.select(".majorPopLabels").node();var av=[ax.getBoundingClientRect().width+5,ax.getBoundingClientRect().height+5];var aF=new Date();var ap=aF.getFullYear()+"-"+aF.getMonth()+"-"+aF.getDate()+"_"+aF.getHours()+"h"+aF.getMinutes()+"m"+aF.getSeconds()+"s";var aD="K="+d3.select("#plot"+ao).attr("class").split(" ")[1]+"_majormode_"+ap+"_pong";if(aC){var aG=aE.getAttribute("class").split(" ");var au=aG[0].slice(aE.getAttribute("class").indexOf("-")+1);if(aG.length<2){aD=ao.substr(0,ao.indexOf("_"))+"_K="+au+"_minormode_"+ap+"_pong"}else{aD=ao.substr(0,ao.indexOf("_"))+"_K="+au+"_majormode_"+ap+"_pong"}ax=d3.select(".minorPopLabels_"+au).node();d3.select(".minorPopLabels_"+au).attr("height",av[1]).attr("width",av[0])}var aA=aE.getBoundingClientRect();var aq=document.createElement("canvas");aq.width=(Math.max(av[0],aA.width/ag.scale()))*t+20;aq.height=(av[1]+aA.height)*t+20;if(ar=="print"){var ay=window.open();ay.document.title="pong download"}if(ar=="svg"){var aw=document.createElementNS("//www.w3.org/2000/svg","svg");aw.setAttribute("width",Math.max(av[0],aA.width/ag.scale()));aw.setAttribute("height",(av[1]+aA.height));aw.appendChild(aE.cloneNode(true));var az=ax.cloneNode(true);az.setAttribute("y",(aA.height));aw.appendChild(az);ab(aw,null,0,function(aH){T(aH,aD+".svg");if(aC){d3.select(".minorPopLabels_"+au).attr("height",a).attr("width",o)}})}else{ab(aE,aq,0,function(aH){ab(ax,aq,(aA.height)*t,function(aI){if(ar=="print"){ay.document.body.appendChild(aH);ay.document.body.appendChild(aI);ay.print()}else{Q(aq,aD+".png")}if(aC){d3.select(".minorPopLabels_"+au).attr("height",a).attr("width",o)}})})}}function ae(ax,at){t=W(ax,true,at);var ay=d3.select(".majorPopLabels").node();var aq=[ay.getBoundingClientRect().width+5,ay.getBoundingClientRect().height+5];var ar=new Date();var aB=ar.getFullYear()+"-"+ar.getMonth()+"-"+ar.getDate()+"_"+ar.getHours()+"h"+ar.getMinutes()+"m"+ar.getSeconds()+"s";var ao="mainviz_"+aB+"_pong";var aE=document.getElementsByClassName("majorSVG");if(ax!="no"){aE=document.getElementsByClassName("minorSVG-"+ax);ao="modes_K="+ax+"_"+aB+"_pong";ay=d3.select(".minorPopLabels_"+ax).node();d3.select(".minorPopLabels_"+ax).attr("height",aq[1]).attr("width",aq[0])}var aA=d3.select(aE[0]).node().getBBox();var ap=document.createElement("canvas");ap.width=(Math.max(aq[0],aA.width/ag.scale()))*t;ap.height=(aq[1]+(aA.height+20)*aE.length)*t;if(at=="print"){var aF=window.open();aF.document.title="pong download"}var az=0;var aD=document.createElementNS("//www.w3.org/2000/svg","svg");aD.setAttribute("width",Math.max(aq[0],aA.width/ag.scale()));aD.setAttribute("height",(aq[1]+(aA.height+20)*aE.length));for(var av=0;av<aE.length;av++){var aw=d3.select(aE[av]);if(at=="svg"){var au=d3.select(aE[av]).node().cloneNode(true);au.setAttribute("y",(aA.height+20)*av);aD.appendChild(au);az+=1;if(az==aE.length){var aC=ay.cloneNode(true);aC.setAttribute("y",(aA.height+20)*aE.length);aD.appendChild(aC);ab(aD,null,0,function(aG){T(aG,ao+".svg");if(ax!="no"){d3.select(".minorPopLabels_"+ax).attr("height",a).attr("width",o)}})}}else{ab(aw.node(),ap,(aA.height+20)*av*t,function(aG){if(at=="print"){aF.document.body.appendChild(aG)}az+=1;if(az==aE.length){ab(ay,ap,(aA.height+20)*aE.length*t,function(aH){if(at=="print"){aF.document.body.appendChild(aH);aF.print()}else{if(at=="png"){Q(ap,ao+".png")}}if(ax!="no"){d3.select(".minorPopLabels_"+ax).attr("height",a).attr("width",o)}})}})}}}function ab(at,ar,ao,av){var au=(new XMLSerializer()).serializeToString(at);var aq=new Image();aq.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(au)));if(ar){var ap=ar.getContext("2d");aq.onload=function(){ap.drawImage(aq,0,0,aq.width,aq.height,0,ao,aq.width*t,aq.height*t);if(av){av(aq);aq.onload=null}}}else{av(aq)}}function y(ap,ao){var at=/[^0-9]/g;var ar=parseInt(ap.replace(at,""),10);var aq=parseInt(ao.replace(at,""),10);return ar===aq?0:ar>aq?1:-1}Y(d3.select("#downloadAllDiv"),"main",d3.select("#downloadAllDropdownLink"),false)});