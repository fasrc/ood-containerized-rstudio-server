#
# Start RStudio Server
#

container_image=<%= context.r_version %>

# Set working directory to home directory
cd "${HOME}"

set -x
# Launch the RStudio Server
echo "Starting up rserver..."

# instead of setting session-timeout-minutes=0 in /etc/rstudio/rsession.conf
# per section 5.2.2 (Session Timeout) in
# https://docs.rstudio.com/ide/server-pro/r-sessions.html#user-and-group-profiles,
# set (undocumented) environment variable gleaned from source code:
# https://github.com/rstudio/rstudio/blob/master/src/cpp/server/ServerSessionManager.cpp#L111
export SINGULARITYENV_RSTUDIO_SESSION_TIMEOUT=0

R_HOME=$(singularity exec --containall ${container_image} R RHOME)

# use a different directory for each image to be safe...
readonly image_tag=$(basename "${container_image##*:}" .sif)
if [ ${image_tag} = 'RELEASE_3_9' ] # legacy RELEASE_3_9 used major.minor version
then
  R_LIBS_USER=${HOME}/R/ifxrstudio/3.6
else
  R_LIBS_USER=${HOME}/R/ifxrstudio/${image_tag}
fi

# Need a unique /tmp for this job for /tmp/rstudio-rsession & /tmp/rstudio-server
# Need writable /run/rstudio-server :
#   https://discourse.osc.edu/t/unable-to-launch-fully-containerized-rstudio/948
WORKDIR=/scratch/${USER}/${SLURM_JOB_ID}
mkdir -m 700 -p ${WORKDIR}/tmp ${WORKDIR}/run "${R_LIBS_USER}"

# Debian /usr/local/lib/R/etc/Renviron hard-codes R_LIBS_USER to /usr/local/lib/R/site-library :
# https://github.com/rocker-org/rocker-versioned/issues/153
# can override in /etc/R/Renviron.site
cat >${WORKDIR}/Renviron.site <<END
R_LIBS_USER=$R_LIBS_USER
END

# rsession needs to start with OMP_NUM_THREADS set to prevent OpenBLAS
# (and any other OpenMP-enhanced libraries used by R) from spawning too many
# threads. Renviron.site appears to be processed too late to prevent this (any
# environment variables set therein are not in rsession's environment) is not
# in the , so instead a wrapper script is created for rsession.
#
# Also set MKL_THREADING_LAYER per:
# https://github.com/eddelbuettel/mkl4deb#set-an-environment-variable

cat > ${WORKDIR}/rsession.sh <<END
#!/bin/sh
set -o xtrace
export OMP_NUM_THREADS=${SLURM_JOB_CPUS_PER_NODE}
export MKL_THREADING_LAYER=GNU
exec rsession "\${@}"
END

chmod +x ${WORKDIR}/rsession.sh

#echo 'log-stderr=1' > ${WORKDIR}/rsession.conf
# --bind "${WORKDIR}/rsession.conf:/etc/rstudio/rsession.conf" \

# bioconductor/bioconductor_docker:RELEASE_3_10 sets USER in Dockerfile:
# https://github.com/Bioconductor/bioconductor_docker/blob/RELEASE_3_10/Dockerfile#L154
#
# Apparently, quay.io/singularity/docker2singularity:v3.5.1 then sets USER in
# the /.singularity.d/env/10-docker.sh, which overrides any externally-set USER
# (in the environment of the "singularity exec" commmand). To work around this,
# setting USER in a shell command that invokes the rserver process

singularity exec --cleanenv \
 --bind "${WORKDIR}/tmp:/tmp" \
 --bind "${WORKDIR}/run:/run" \
 --bind "${WORKDIR}/Renviron.site:${R_HOME}/etc/Renviron.site" \
 --bind "${WORKDIR}/rsession.sh:/etc/rstudio/rsession.sh" \
 "${container_image}" \
 sh -c "USER=${USER} rserver \
 --www-port ${port} \
 --auth-none 0 \
 --auth-encrypt-password 0 \
 --auth-pam-helper-path=pam-helper \
 --rsession-path=/etc/rstudio/rsession.sh"
