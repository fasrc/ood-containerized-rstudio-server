#
# Start RStudio Server
#

container_image=<%= context.r_version %>

# Set working directory to home directory
cd "${HOME}"

set -x
# Launch the RStudio Server
echo "Starting up rserver..."

# instead of setting session-timeout-minutes=0 in /etc/rstudio/rsession.conf
# per section 5.2.2 (Session Timeout) in
# https://docs.rstudio.com/ide/server-pro/r-sessions.html#user-and-group-profiles,
# set (undocumented) environment variable gleaned from source code:
# https://github.com/rstudio/rstudio/blob/master/src/cpp/server/ServerSessionManager.cpp#L111
export SINGULARITYENV_RSTUDIO_SESSION_TIMEOUT=0

R_VERSION=$(singularity exec --cleanenv --contain ${container_image} Rscript -e 'cat(R.Version()$major,sub(".[0-9]+$","",R.Version()$minor), sep=".")')
R_HOME=$(singularity exec --cleanenv --contain ${container_image} R RHOME)
R_LIBS_USER=${HOME}/R/rocker/${R_VERSION}
# Need a unique /tmp for this job for /tmp/rstudio-rsession & /tmp/rstudio-server
WORKDIR=/scratch/${USER}/${SLURM_JOB_ID}
mkdir -m 700 -p ${WORKDIR}/tmp "${R_LIBS_USER}"

# Debian /usr/local/lib/R/etc/Renviron hard-codes R_LIBS_USER to /usr/local/lib/R/site-library :
# https://github.com/rocker-org/rocker-versioned/issues/153
# can override in /etc/R/Renviron.site
echo "R_LIBS_USER=$R_LIBS_USER" > ${WORKDIR}/Renviron.site
#echo 'log-stderr=1' > ${WORKDIR}/rsession.conf
# --bind "${WORKDIR}/rsession.conf:/etc/rstudio/rsession.conf" \

singularity exec --cleanenv \
 --bind "${WORKDIR}/tmp:/tmp" \
 --bind "${WORKDIR}/Renviron.site:${R_HOME}/etc/Renviron.site" \
 "${container_image}" \
 rserver \
 --www-port "${port}" \
 --auth-none 0 \
 --auth-encrypt-password 0 \
 --auth-pam-helper-path=pam-helper
