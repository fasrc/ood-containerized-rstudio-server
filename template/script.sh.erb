#
# Start RStudio Server
#

container_image=<%= context.r_version %>

# Set working directory to home directory
cd "${HOME}"

set -x
# Launch the RStudio Server
echo "Starting up rserver..."

# instead of setting session-timeout-minutes=0 in /etc/rstudio/rsession.conf
# per section 5.2.2 (Session Timeout) in
# https://docs.rstudio.com/ide/server-pro/r-sessions.html#user-and-group-profiles,
# set (undocumented) environment variable gleaned from source code:
# https://github.com/rstudio/rstudio/blob/master/src/cpp/server/ServerSessionManager.cpp#L111
export SINGULARITYENV_RSTUDIO_SESSION_TIMEOUT=0

R_VERSION=$(singularity exec --cleanenv --contain ${container_image} Rscript -e 'cat(R.Version()$major,sub(".[0-9]+$","",R.Version()$minor), sep=".")')
R_HOME=$(singularity exec --cleanenv --contain ${container_image} R RHOME)
SINGULARITYENV_R_LIBS_USER=${HOME}/R/ifxrstudio/${R_VERSION}
# Need a unique /tmp for this job for /tmp/rstudio-rsession & /tmp/rstudio-server
WORKDIR=/scratch/${USER}/${SLURM_JOB_ID}
mkdir -m 700 -p ${WORKDIR}/tmp "${SINGULARITYENV_R_LIBS_USER}"

# rsession needs to start with OMP_NUM_THREADS set to prevent OpenBLAS
# (and any other OpenMP-enhanced libraries used by R) from spawning too many
# threads. Renviron.site appears to be processed too late to prevent this (any
# environment variables set therein are not in rsession's environment) is not
# in the , so instead a wrapper script is created for rsession.

cat > ${WORKDIR}/rsession.sh <<END
#!/bin/sh
set -o xtrace
export OMP_NUM_THREADS=${SLURM_JOB_CPUS_PER_NODE}
exec rsession "\${@}"
END

chmod +x ${WORKDIR}/rsession.sh

#echo 'log-stderr=1' > ${WORKDIR}/rsession.conf
# --bind "${WORKDIR}/rsession.conf:/etc/rstudio/rsession.conf" \

singularity exec --cleanenv \
 --bind "${WORKDIR}/tmp:/tmp" \
 --bind "${WORKDIR}/rsession.sh:/etc/rstudio/rsession.sh" \
 "${container_image}" \
 rserver \
 --www-port "${port}" \
 --auth-none 0 \
 --auth-encrypt-password 0 \
 --auth-pam-helper-path=pam-helper \
 --rsession-path=/etc/rstudio/rsession.sh
